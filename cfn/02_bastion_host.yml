---
AWSTemplateFormatVersion: '2010-09-09'

Parameters:

  BastionKeyName:
    Type: AWS::EC2::KeyPair::KeyName

  BastionEC2LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'

  BastionVPC:
    Type: AWS::EC2::VPC::Id

  BastionPublicSubnet01:
    Type: AWS::EC2::Subnet::Id

Resources:

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.medium
      ImageId: !Ref 'BastionEC2LatestAmiId'
      KeyName:
        Ref: BastionKeyName
      NetworkInterfaces:
      - AssociatePublicIpAddress: true
        DeviceIndex: "0"
        GroupSet:
          - Ref: "EC2InstanceSecurityGroup"
        SubnetId:
          Ref: "BastionPublicSubnet01"
      Tags:
      - Key: Name
        Value: WORKSHOP-Bastion-Instance
      UserData: Q29udGVudC1UeXBlOiBtdWx0aXBhcnQvbWl4ZWQ7IGJvdW5kYXJ5PSI9PT09PT09PT09PT09PT1FS1NXT1JLU0hPUD09IgpNSU1FLVZlcnNpb246IDEuMApOdW1iZXItQXR0YWNobWVudHM6IDEKCi0tPT09PT09PT09PT09PT09RUtTV09SS1NIT1A9PQpNSU1FLVZlcnNpb246IDEuMApDb250ZW50LVR5cGU6IHRleHQvY2xvdWQtY29uZmlnCkNvbnRlbnQtRGlzcG9zaXRpb246IGF0dGFjaG1lbnQ7IGZpbGVuYW1lPSJwYXJ0LTAwMSIKCiNjbG91ZC1jb25maWcKcGFja2FnZXM6CiAgLSBnaXQKICAtIGpxCnBhY2thZ2VfdXBncmFkZTogdHJ1ZQpwYWNrYWdlX3VwZGF0ZTogdHJ1ZQpydW5jbWQ6Ci0gLSAvdmFyL2xpYi9jbG91ZC9zY3JpcHRzL3Blci1pbnN0YW5jZS9ib290c3RyYXAuYWwyLnNoCndyaXRlX2ZpbGVzOgotIGNvbnRlbnQ6IHwKICAgICMhL2Jpbi9iYXNoCgogICAgc2V0IC1vIGVycmV4aXQKICAgIHNldCAtbyBwaXBlZmFpbAogICAgc2V0IC1vIG5vdW5zZXQKICAgIFNUQUNLX05BTUU9IldPUktTSE9QIgogICAgRUtTX0NMVVNURVJfTkFNRT0iRUtTLVdPUktTSE9QIgogICAgRUtTX1NUQUNLX05BTUU9ImVrc2N0bC1FS1MtV09SS1NIT1AtY2x1c3RlciIKICAgIFRPS0VOPSQoY3VybCAtWCBQVVQgLUggIlgtYXdzLWVjMi1tZXRhZGF0YS10b2tlbi10dGwtc2Vjb25kczogNjAwIiAiaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvYXBpL3Rva2VuIikKICAgIEFXU19ERUZBVUxUX1JFR0lPTj0kKGN1cmwgLXMgLS1yZXRyeSA1IC1IICJYLWF3cy1lYzItbWV0YWRhdGEtdG9rZW46ICRUT0tFTiIgaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvZHluYW1pYy9pbnN0YW5jZS1pZGVudGl0eS9kb2N1bWVudCB8IGpxIC5yZWdpb24gLXIpCgogICAgZnVuY3Rpb24gaW5pdF9jbGkoKSB7CiAgICAgICAgIyBJbnN0YWxsIGt1YmVjdGwsIFJlZjogaHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvdGFza3MvdG9vbHMvaW5zdGFsbC1rdWJlY3RsLwogICAgICAgIGN1cmwgLXNMICJodHRwczovL3N0b3JhZ2UuZ29vZ2xlYXBpcy5jb20va3ViZXJuZXRlcy1yZWxlYXNlL3JlbGVhc2UvJChjdXJsIC1zIGh0dHBzOi8vc3RvcmFnZS5nb29nbGVhcGlzLmNvbS9rdWJlcm5ldGVzLXJlbGVhc2UvcmVsZWFzZS9zdGFibGUudHh0KS9iaW4vbGludXgvYW1kNjQva3ViZWN0bCIgLW8gL3RtcC9rdWJlY3RsCiAgICAgICAgY2htb2QgK3ggL3RtcC9rdWJlY3RsCiAgICAgICAgbXYgL3RtcC9rdWJlY3RsIC91c3IvbG9jYWwvYmluCiAgICAgICAgIyBJbnN0YWxsIGVrc2N0bCwgUmVmOiBodHRwczovL2Vrc2N0bC5pby9pbnRyb2R1Y3Rpb24vI2luc3RhbGxhdGlvbgogICAgICAgIGN1cmwgLXNMICJodHRwczovL2dpdGh1Yi5jb20vd2VhdmV3b3Jrcy9la3NjdGwvcmVsZWFzZXMvbGF0ZXN0L2Rvd25sb2FkL2Vrc2N0bF8kKHVuYW1lIC1zKV9hbWQ2NC50YXIuZ3oiIHwgdGFyIHh6IC1DIC90bXAKICAgICAgICBjaG1vZCAreCAvdG1wL2Vrc2N0bAogICAgICAgIG12IC90bXAvZWtzY3RsIC91c3IvbG9jYWwvYmluCiAgICAgICAgIyBJbnN0YWxsIGF3c2NsaSwgUmVmOiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY2xpL2xhdGVzdC91c2VyZ3VpZGUvaW5zdGFsbC1jbGl2Mi1saW51eC5odG1sI2NsaXYyLWxpbnV4LWluc3RhbGwKICAgICAgICB5dW0gcmVtb3ZlIGF3c2NsaSAteQogICAgICAgIGN1cmwgLXNMICJodHRwczovL2F3c2NsaS5hbWF6b25hd3MuY29tL2F3c2NsaS1leGUtbGludXgteDg2XzY0LnppcCIgLW8gL3RtcC9hd3NjbGl2Mi56aXAKICAgICAgICB1bnppcCAvdG1wL2F3c2NsaXYyLnppcCAtZCAvdG1wLwogICAgICAgIHNoIC90bXAvYXdzL2luc3RhbGwKICAgICAgICAjIEFkZCBhd3MgY2xpIGNvbmZpZyBhbmQgYWRkIGF1dG8gY29tcGxldGlvbgogICAgICAgIGVjaG8gLWUgImNvbXBsZXRlIC1DICcvdXNyL2xvY2FsL2Jpbi9hd3NfY29tcGxldGVyJyBhd3NcbnNvdXJjZSA8KGt1YmVjdGwgY29tcGxldGlvbiBiYXNoKVxuc291cmNlIDwoZWtzY3RsIGNvbXBsZXRpb24gYmFzaCkiID4+IC9ldGMvYmFzaHJjCiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlX2NsdXN0ZXIoKSB7CiAgICAgICAgUFVCTElDX1NVQk5FVFM9JChhd3MgY2xvdWRmb3JtYXRpb24gZGVzY3JpYmUtc3RhY2tzIC0tc3RhY2sgIiRTVEFDS19OQU1FIiB8IGpxIC1yICcuU3RhY2tzW10uT3V0cHV0c1tdIHwgc2VsZWN0KC5PdXRwdXRLZXk9PSJQdWJsaWNTdWJuZXRTdWJuZXRJZHMiKS5PdXRwdXRWYWx1ZScpCiAgICAgICAgUFJJVkFURV9TVUJORVRTPSQoYXdzIGNsb3VkZm9ybWF0aW9uIGRlc2NyaWJlLXN0YWNrcyAtLXN0YWNrICIkU1RBQ0tfTkFNRSIgfCBqcSAtciAnLlN0YWNrc1tdLk91dHB1dHNbXSB8IHNlbGVjdCguT3V0cHV0S2V5PT0iUHJpdmF0ZVN1Ym5ldFN1Ym5ldElkcyIpLk91dHB1dFZhbHVlJykKICAgICAgICBWUEM9JChhd3MgY2xvdWRmb3JtYXRpb24gZGVzY3JpYmUtc3RhY2tzIC0tc3RhY2sgIiRTVEFDS19OQU1FIiB8IGpxIC1yICcuU3RhY2tzW10uT3V0cHV0c1tdIHwgc2VsZWN0KC5PdXRwdXRLZXk9PSJWcGNJZCIpLk91dHB1dFZhbHVlJykKICAgICAgICBLRVlOQU1FPSQoYXdzIGNsb3VkZm9ybWF0aW9uIGRlc2NyaWJlLXN0YWNrcyAtLXN0YWNrICIkU1RBQ0tfTkFNRSIgfCBqcSAtciAnLlN0YWNrc1tdLk91dHB1dHNbXSB8IHNlbGVjdCguT3V0cHV0S2V5PT0iRUMyS2V5TmFtZSIpLk91dHB1dFZhbHVlJykKCiAgICAgICAgZWtzY3RsIGNyZWF0ZSBjbHVzdGVyIFwKICAgICAgICAgICAgLS1uYW1lICIkRUtTX0NMVVNURVJfTkFNRSIgXAogICAgICAgICAgICAtLXZlcnNpb24gMS4yMSBcCiAgICAgICAgICAgIC0td2l0aC1vaWRjIFwKICAgICAgICAgICAgLS13aXRob3V0LW5vZGVncm91cCBcCiAgICAgICAgICAgIC0tdnBjLXByaXZhdGUtc3VibmV0cz0iJFBSSVZBVEVfU1VCTkVUUyIgXAogICAgICAgICAgICAtLXZwYy1wdWJsaWMtc3VibmV0cz0iJFBVQkxJQ19TVUJORVRTIiBcCiAgICAgICAgICAgIC0tcmVnaW9uICIkQVdTX0RFRkFVTFRfUkVHSU9OIgoKICAgICAgICBhd3MgZWtzIHdhaXQgY2x1c3Rlci1hY3RpdmUgXAogICAgICAgICAgICAtLXJlZ2lvbj0iJEFXU19ERUZBVUxUX1JFR0lPTiIgXAogICAgICAgICAgICAtLW5hbWU9IiRFS1NfQ0xVU1RFUl9OQU1FIgoKICAgICAgICBla3NjdGwgdXRpbHMgc2V0LXB1YmxpYy1hY2Nlc3MtY2lkcnMgXAogICAgICAgICAgICAtLWNsdXN0ZXI9IiRFS1NfQ0xVU1RFUl9OQU1FIiAiJChjdXJsIC1zIGNoZWNraXAuYW1hem9uYXdzLmNvbSkvMzIiIFwKICAgICAgICAgICAgLS1yZWdpb24gIiRBV1NfREVGQVVMVF9SRUdJT04iIFwKICAgICAgICAgICAgLS1hcHByb3ZlCgogICAgICAgIENPTlRST0xfUExBTkVfU0c9JChhd3MgY2xvdWRmb3JtYXRpb24gZGVzY3JpYmUtc3RhY2tzIC0tc3RhY2sgIiRFS1NfU1RBQ0tfTkFNRSIgfCBqcSAtciAnLlN0YWNrc1tdLk91dHB1dHNbXSB8IHNlbGVjdCguT3V0cHV0S2V5PT0iU2VjdXJpdHlHcm91cCIpLk91dHB1dFZhbHVlJykKCgogICAgICAgIFJFUExBQ0VfUFJJVkFURV9TVUJORVRTPSQoZWNobyAiJHtQUklWQVRFX1NVQk5FVFMvLywvXFwsfSIpCgogICAgICAgIGF3cyBjbG91ZGZvcm1hdGlvbiBjcmVhdGUtc3RhY2sgXAogICAgICAgICAgICAtLXN0YWNrLW5hbWUgV09SS1NIT1AtTkcgXAogICAgICAgICAgICAtLXRlbXBsYXRlLWJvZHkgZmlsZTovLy92YXIvbGliL2Nsb3VkL3NjcmlwdHMvcGVyLWluc3RhbmNlL2Vrcy1ub2RlZ3JvdXAueWFtbCBcCiAgICAgICAgICAgIC0tcGFyYW1ldGVycyBQYXJhbWV0ZXJLZXk9S2V5TmFtZSxQYXJhbWV0ZXJWYWx1ZT0iJEtFWU5BTUUiIFwKICAgICAgICAgICAgICAgICAgICAgICAgIFBhcmFtZXRlcktleT1TdWJuZXRzLFBhcmFtZXRlclZhbHVlPSIkUkVQTEFDRV9QUklWQVRFX1NVQk5FVFMiIFwKICAgICAgICAgICAgICAgICAgICAgICAgIFBhcmFtZXRlcktleT1DbHVzdGVyQ29udHJvbFBsYW5lU2VjdXJpdHlHcm91cCxQYXJhbWV0ZXJWYWx1ZT0iJENPTlRST0xfUExBTkVfU0ciIFwKICAgICAgICAgICAgICAgICAgICAgICAgIFBhcmFtZXRlcktleT1WcGNJZCxQYXJhbWV0ZXJWYWx1ZT0iJFZQQyIgXAogICAgICAgICAgICAtLWNhcGFiaWxpdGllcyBDQVBBQklMSVRZX0lBTSBcCiAgICAgICAgICAgIC0tcmVnaW9uICIkQVdTX0RFRkFVTFRfUkVHSU9OIgoKICAgICAgICBhd3MgZWtzIHVwZGF0ZS1rdWJlY29uZmlnIC0tbmFtZSBFS1MtV09SS1NIT1AgLS1rdWJlY29uZmlnIC9ob21lL2VjMi11c2VyLy5rdWJlL2NvbmZpZwogICAgICAgIGNob3duIC1SIGVjMi11c2VyOmVjMi11c2VyIC9ob21lL2VjMi11c2VyLy5rdWJlLwoKICAgIH0KCiAgICBmdW5jdGlvbiBpbnN0YWxsX2hlbG0oKSB7CiAgICAgICAgY3VybCAtZnNTTCAtbyBnZXRfaGVsbS5zaCBodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vaGVsbS9oZWxtL21hc3Rlci9zY3JpcHRzL2dldC1oZWxtLTMKICAgICAgICBjaG1vZCA3MDAgZ2V0X2hlbG0uc2gKICAgICAgICAuL2dldF9oZWxtLnNoCiAgICAgICAgcm0gZ2V0X2hlbG0uc2gKICAgIH0KCiAgICBpbml0X2NsaQogICAgY3JlYXRlX2NsdXN0ZXIKICAgIGluc3RhbGxfaGVsbQoKCiAgb3duZXI6IHJvb3Q6cm9vdAogIHBhdGg6IC92YXIvbGliL2Nsb3VkL3NjcmlwdHMvcGVyLWluc3RhbmNlL2Jvb3RzdHJhcC5hbDIuc2gKICBwZXJtaXNzaW9uczogIjA3NTUiCi0gY29udGVudDogfAogICAgQVdTVGVtcGxhdGVGb3JtYXRWZXJzaW9uOiAiMjAxMC0wOS0wOSIKCiAgICBEZXNjcmlwdGlvbjogPgogICAgICBMZWFybmluZyBzZXJpZXMgTGFiIGFzc2Vzc21lbnQgLSBFS1Mgd29ya2VyIG5vZGVzIGNhbiBub3Qgam9pbiB0aGUgRUtTIGNsdXN0ZXIuCiAgICAgIENyZWF0ZWQgYnkgbGlib2h5dW5AYW1hem9uLmNvbQoKICAgIE1ldGFkYXRhOgogICAgICAiQVdTOjpDbG91ZEZvcm1hdGlvbjo6SW50ZXJmYWNlIjoKICAgICAgICBQYXJhbWV0ZXJHcm91cHM6CiAgICAgICAgICAtIExhYmVsOgogICAgICAgICAgICAgIGRlZmF1bHQ6IEVLUyBDbHVzdGVyCiAgICAgICAgICAgIFBhcmFtZXRlcnM6CiAgICAgICAgICAgICAgLSBDbHVzdGVyQ29udHJvbFBsYW5lU2VjdXJpdHlHcm91cAogICAgICAgICAgLSBMYWJlbDoKICAgICAgICAgICAgICBkZWZhdWx0OiBXb3JrZXIgTm9kZSBDb25maWd1cmF0aW9uCiAgICAgICAgICAgIFBhcmFtZXRlcnM6CiAgICAgICAgICAgICAgLSBOb2RlSW1hZ2VJZAogICAgICAgICAgICAgIC0gS2V5TmFtZQogICAgICAgICAgLSBMYWJlbDoKICAgICAgICAgICAgICBkZWZhdWx0OiBXb3JrZXIgTmV0d29yayBDb25maWd1cmF0aW9uCiAgICAgICAgICAgIFBhcmFtZXRlcnM6CiAgICAgICAgICAgICAgLSBWcGNJZAogICAgICAgICAgICAgIC0gU3VibmV0cwoKICAgIFBhcmFtZXRlcnM6CiAgICAgIENsdXN0ZXJDb250cm9sUGxhbmVTZWN1cml0eUdyb3VwOgogICAgICAgIFR5cGU6ICJBV1M6OkVDMjo6U2VjdXJpdHlHcm91cDo6SWQiCiAgICAgICAgRGVzY3JpcHRpb246IFRoZSBzZWN1cml0eSBncm91cCBvZiB0aGUgY2x1c3RlciBjb250cm9sIHBsYW5lLgoKICAgICAgS2V5TmFtZToKICAgICAgICBUeXBlOiAiQVdTOjpFQzI6OktleVBhaXI6OktleU5hbWUiCiAgICAgICAgRGVzY3JpcHRpb246IFRoZSBFQzIgS2V5IFBhaXIgdG8gYWxsb3cgU1NIIGFjY2VzcyB0byB0aGUgaW5zdGFuY2VzCgogICAgICBOb2RlSW1hZ2VJZDoKICAgICAgICBUeXBlOiAiQVdTOjpTU006OlBhcmFtZXRlcjo6VmFsdWU8QVdTOjpFQzI6OkltYWdlOjpJZD4iCiAgICAgICAgRGVmYXVsdDogL2F3cy9zZXJ2aWNlL2Vrcy9vcHRpbWl6ZWQtYW1pLzEuMjEvYW1hem9uLWxpbnV4LTIvcmVjb21tZW5kZWQvaW1hZ2VfaWQKICAgICAgICBEZXNjcmlwdGlvbjogU3BlY2lmeSB5b3VyIG93biBjdXN0b20gaW1hZ2UgSUQuCgogICAgICBTdWJuZXRzOgogICAgICAgIFR5cGU6ICJMaXN0PEFXUzo6RUMyOjpTdWJuZXQ6OklkPiIKICAgICAgICBEZXNjcmlwdGlvbjogVGhlIHN1Ym5ldHMgd2hlcmUgd29ya2VycyBjYW4gYmUgY3JlYXRlZC4KCiAgICAgIFZwY0lkOgogICAgICAgIFR5cGU6ICJBV1M6OkVDMjo6VlBDOjpJZCIKICAgICAgICBEZXNjcmlwdGlvbjogVGhlIFZQQyBvZiB0aGUgd29ya2VyIGluc3RhbmNlcwoKICAgIFJlc291cmNlczoKICAgICAgTm9kZUluc3RhbmNlUm9sZToKICAgICAgICBUeXBlOiAiQVdTOjpJQU06OlJvbGUiCiAgICAgICAgUHJvcGVydGllczoKICAgICAgICAgIEFzc3VtZVJvbGVQb2xpY3lEb2N1bWVudDoKICAgICAgICAgICAgVmVyc2lvbjogIjIwMTItMTAtMTciCiAgICAgICAgICAgIFN0YXRlbWVudDoKICAgICAgICAgICAgICAtIEVmZmVjdDogQWxsb3cKICAgICAgICAgICAgICAgIFByaW5jaXBhbDoKICAgICAgICAgICAgICAgICAgU2VydmljZToKICAgICAgICAgICAgICAgICAgICAtIGVjMi5hbWF6b25hd3MuY29tCiAgICAgICAgICAgICAgICBBY3Rpb246CiAgICAgICAgICAgICAgICAgIC0gInN0czpBc3N1bWVSb2xlIgogICAgICAgICAgTWFuYWdlZFBvbGljeUFybnM6CiAgICAgICAgICAgIC0gIVN1YiAiYXJuOiR7QVdTOjpQYXJ0aXRpb259OmlhbTo6YXdzOnBvbGljeS9BbWF6b25FS1NXb3JrZXJOb2RlUG9saWN5IgogICAgICAgICAgICAtICFTdWIgImFybjoke0FXUzo6UGFydGl0aW9ufTppYW06OmF3czpwb2xpY3kvQW1hem9uRUtTX0NOSV9Qb2xpY3kiCiAgICAgICAgICAgIC0gIVN1YiAiYXJuOiR7QVdTOjpQYXJ0aXRpb259OmlhbTo6YXdzOnBvbGljeS9BbWF6b25FQzJDb250YWluZXJSZWdpc3RyeVJlYWRPbmx5IgogICAgICAgICAgUGF0aDogLwoKICAgICAgTm9kZUluc3RhbmNlUHJvZmlsZToKICAgICAgICBUeXBlOiAiQVdTOjpJQU06Okluc3RhbmNlUHJvZmlsZSIKICAgICAgICBQcm9wZXJ0aWVzOgogICAgICAgICAgUGF0aDogLwogICAgICAgICAgUm9sZXM6CiAgICAgICAgICAgIC0gIVJlZiBOb2RlSW5zdGFuY2VSb2xlCgogICAgICBOb2RlU2VjdXJpdHlHcm91cDoKICAgICAgICBUeXBlOiAiQVdTOjpFQzI6OlNlY3VyaXR5R3JvdXAiCiAgICAgICAgUHJvcGVydGllczoKICAgICAgICAgIEdyb3VwRGVzY3JpcHRpb246IFNlY3VyaXR5IGdyb3VwIGZvciBhbGwgbm9kZXMgaW4gdGhlIGNsdXN0ZXIKICAgICAgICAgIFRhZ3M6CiAgICAgICAgICAgIC0gS2V5OiBrdWJlcm5ldGVzLmlvL2NsdXN0ZXIvRUtTLVdPUktTSE9QCiAgICAgICAgICAgICAgVmFsdWU6IG93bmVkCiAgICAgICAgICBWcGNJZDogIVJlZiBWcGNJZAoKICAgICAgTm9kZVNlY3VyaXR5R3JvdXBJbmdyZXNzOgogICAgICAgIFR5cGU6ICJBV1M6OkVDMjo6U2VjdXJpdHlHcm91cEluZ3Jlc3MiCiAgICAgICAgUHJvcGVydGllczoKICAgICAgICAgIERlc2NyaXB0aW9uOiBBbGxvdyBub2RlIHRvIGNvbW11bmljYXRlIHdpdGggZWFjaCBvdGhlcgogICAgICAgICAgRnJvbVBvcnQ6IDAKICAgICAgICAgIEdyb3VwSWQ6ICFSZWYgTm9kZVNlY3VyaXR5R3JvdXAKICAgICAgICAgIElwUHJvdG9jb2w6ICItMSIKICAgICAgICAgIFNvdXJjZVNlY3VyaXR5R3JvdXBJZDogIVJlZiBOb2RlU2VjdXJpdHlHcm91cAogICAgICAgICAgVG9Qb3J0OiA2NTUzNQoKICAgICAgTm9kZVNlY3VyaXR5R3JvdXBGcm9tQmFzdGlvbk9uMjJJbmdyZXNzOgogICAgICAgIFR5cGU6ICJBV1M6OkVDMjo6U2VjdXJpdHlHcm91cEluZ3Jlc3MiCiAgICAgICAgUHJvcGVydGllczoKICAgICAgICAgIERlc2NyaXB0aW9uOiBBbGxvdyBTU0ggb24gcG9ydCAyMiB0byByZWNlaXZlIGNvbW11bmljYXRpb24gZnJvbSBiYXN0aW9uIGluc3RhbmNlCiAgICAgICAgICBGcm9tUG9ydDogMjIKICAgICAgICAgIEdyb3VwSWQ6ICFSZWYgTm9kZVNlY3VyaXR5R3JvdXAKICAgICAgICAgIElwUHJvdG9jb2w6IHRjcAogICAgICAgICAgVG9Qb3J0OiAyMgogICAgICAgICAgQ2lkcklwOiAxOTIuMTY4LjAuMC8xNgoKICAgICAgQ2x1c3RlckNvbnRyb2xQbGFuZVNlY3VyaXR5R3JvdXBJbmdyZXNzOgogICAgICAgIFR5cGU6ICJBV1M6OkVDMjo6U2VjdXJpdHlHcm91cEluZ3Jlc3MiCiAgICAgICAgUHJvcGVydGllczoKICAgICAgICAgIERlc2NyaXB0aW9uOiBBbGxvdyBwb2RzIHRvIGNvbW11bmljYXRlIHdpdGggdGhlIGNsdXN0ZXIgQVBJIFNlcnZlcgogICAgICAgICAgRnJvbVBvcnQ6IDQ0MwogICAgICAgICAgR3JvdXBJZDogIVJlZiBDbHVzdGVyQ29udHJvbFBsYW5lU2VjdXJpdHlHcm91cAogICAgICAgICAgSXBQcm90b2NvbDogdGNwCiAgICAgICAgICBTb3VyY2VTZWN1cml0eUdyb3VwSWQ6ICFSZWYgTm9kZVNlY3VyaXR5R3JvdXAKICAgICAgICAgIFRvUG9ydDogNDQzCgogICAgICBDb250cm9sUGxhbmVFZ3Jlc3NUb05vZGVTZWN1cml0eUdyb3VwOgogICAgICAgIFR5cGU6ICJBV1M6OkVDMjo6U2VjdXJpdHlHcm91cEVncmVzcyIKICAgICAgICBQcm9wZXJ0aWVzOgogICAgICAgICAgRGVzY3JpcHRpb246IEFsbG93IHRoZSBjbHVzdGVyIGNvbnRyb2wgcGxhbmUgdG8gY29tbXVuaWNhdGUgd2l0aCB3b3JrZXIgS3ViZWxldCBhbmQgcG9kcwogICAgICAgICAgRGVzdGluYXRpb25TZWN1cml0eUdyb3VwSWQ6ICFSZWYgTm9kZVNlY3VyaXR5R3JvdXAKICAgICAgICAgIEZyb21Qb3J0OiAxMDI1CiAgICAgICAgICBHcm91cElkOiAhUmVmIENsdXN0ZXJDb250cm9sUGxhbmVTZWN1cml0eUdyb3VwCiAgICAgICAgICBJcFByb3RvY29sOiB0Y3AKICAgICAgICAgIFRvUG9ydDogNjU1MzUKCiAgICAgIENvbnRyb2xQbGFuZUVncmVzc1RvTm9kZVNlY3VyaXR5R3JvdXBPbjQ0MzoKICAgICAgICBUeXBlOiAiQVdTOjpFQzI6OlNlY3VyaXR5R3JvdXBFZ3Jlc3MiCiAgICAgICAgUHJvcGVydGllczoKICAgICAgICAgIERlc2NyaXB0aW9uOiBBbGxvdyB0aGUgY2x1c3RlciBjb250cm9sIHBsYW5lIHRvIGNvbW11bmljYXRlIHdpdGggcG9kcyBydW5uaW5nIGV4dGVuc2lvbiBBUEkgc2VydmVycyBvbiBwb3J0IDQ0MwogICAgICAgICAgRGVzdGluYXRpb25TZWN1cml0eUdyb3VwSWQ6ICFSZWYgTm9kZVNlY3VyaXR5R3JvdXAKICAgICAgICAgIEZyb21Qb3J0OiA0NDMKICAgICAgICAgIEdyb3VwSWQ6ICFSZWYgQ2x1c3RlckNvbnRyb2xQbGFuZVNlY3VyaXR5R3JvdXAKICAgICAgICAgIElwUHJvdG9jb2w6IHRjcAogICAgICAgICAgVG9Qb3J0OiA0NDMKCiAgICAgIE5vZGVTZWN1cml0eUdyb3VwRnJvbUNvbnRyb2xQbGFuZUluZ3Jlc3M6CiAgICAgICAgVHlwZTogIkFXUzo6RUMyOjpTZWN1cml0eUdyb3VwSW5ncmVzcyIKICAgICAgICBQcm9wZXJ0aWVzOgogICAgICAgICAgRGVzY3JpcHRpb246IEFsbG93IHdvcmtlciBLdWJlbGV0cyBhbmQgcG9kcyB0byByZWNlaXZlIGNvbW11bmljYXRpb24gZnJvbSB0aGUgY2x1c3RlciBjb250cm9sIHBsYW5lCiAgICAgICAgICBGcm9tUG9ydDogMTAyNQogICAgICAgICAgR3JvdXBJZDogIVJlZiBOb2RlU2VjdXJpdHlHcm91cAogICAgICAgICAgSXBQcm90b2NvbDogdGNwCiAgICAgICAgICBTb3VyY2VTZWN1cml0eUdyb3VwSWQ6ICFSZWYgQ2x1c3RlckNvbnRyb2xQbGFuZVNlY3VyaXR5R3JvdXAKICAgICAgICAgIFRvUG9ydDogNjU1MzUKCiAgICAgIE5vZGVTZWN1cml0eUdyb3VwRnJvbUNvbnRyb2xQbGFuZU9uNDQzSW5ncmVzczoKICAgICAgICBUeXBlOiAiQVdTOjpFQzI6OlNlY3VyaXR5R3JvdXBJbmdyZXNzIgogICAgICAgIFByb3BlcnRpZXM6CiAgICAgICAgICBEZXNjcmlwdGlvbjogQWxsb3cgcG9kcyBydW5uaW5nIGV4dGVuc2lvbiBBUEkgc2VydmVycyBvbiBwb3J0IDQ0MyB0byByZWNlaXZlIGNvbW11bmljYXRpb24gZnJvbSBjbHVzdGVyIGNvbnRyb2wgcGxhbmUKICAgICAgICAgIEZyb21Qb3J0OiA0NDMKICAgICAgICAgIEdyb3VwSWQ6ICFSZWYgTm9kZVNlY3VyaXR5R3JvdXAKICAgICAgICAgIElwUHJvdG9jb2w6IHRjcAogICAgICAgICAgU291cmNlU2VjdXJpdHlHcm91cElkOiAhUmVmIENsdXN0ZXJDb250cm9sUGxhbmVTZWN1cml0eUdyb3VwCiAgICAgICAgICBUb1BvcnQ6IDQ0MwoKICAgICAgTm9kZUxhdW5jaFRlbXBsYXRlOgogICAgICAgIFR5cGU6ICJBV1M6OkVDMjo6TGF1bmNoVGVtcGxhdGUiCiAgICAgICAgUHJvcGVydGllczoKICAgICAgICAgIExhdW5jaFRlbXBsYXRlRGF0YToKICAgICAgICAgICAgQmxvY2tEZXZpY2VNYXBwaW5nczoKICAgICAgICAgICAgICAtIERldmljZU5hbWU6IC9kZXYveHZkYQogICAgICAgICAgICAgICAgRWJzOgogICAgICAgICAgICAgICAgICBEZWxldGVPblRlcm1pbmF0aW9uOiB0cnVlCiAgICAgICAgICAgICAgICAgIFZvbHVtZVNpemU6IDIwCiAgICAgICAgICAgICAgICAgIFZvbHVtZVR5cGU6IGdwMgogICAgICAgICAgICBJYW1JbnN0YW5jZVByb2ZpbGU6CiAgICAgICAgICAgICAgQXJuOiAhR2V0QXR0IE5vZGVJbnN0YW5jZVByb2ZpbGUuQXJuCiAgICAgICAgICAgIEltYWdlSWQ6ICFSZWYgTm9kZUltYWdlSWQKICAgICAgICAgICAgSW5zdGFuY2VUeXBlOiB0My5tZWRpdW0KICAgICAgICAgICAgS2V5TmFtZTogIVJlZiBLZXlOYW1lCiAgICAgICAgICAgIFNlY3VyaXR5R3JvdXBJZHM6CiAgICAgICAgICAgIC0gIVJlZiBOb2RlU2VjdXJpdHlHcm91cAogICAgICAgICAgICBVc2VyRGF0YTogIUJhc2U2NAogICAgICAgICAgICAgICJGbjo6U3ViIjogfAogICAgICAgICAgICAgICAgIyEvYmluL2Jhc2gKICAgICAgICAgICAgICAgIHNldCAtbyB4dHJhY2UKICAgICAgICAgICAgICAgIC9ldGMvZWtzL2Jvb3RzdHJhcC5zaCBFS1MtV09SS1NIT1AKICAgICAgICAgICAgICAgIHN1ZG8gc3lzdGVtY3RsIHN0b3Aga3ViZWxldAogICAgICAgICAgICAgICAgL29wdC9hd3MvYmluL2Nmbi1zaWduYWwgLS1leGl0LWNvZGUgJD8gXAogICAgICAgICAgICAgICAgICAgICAgICAtLXN0YWNrICAke0FXUzo6U3RhY2tOYW1lfSBcCiAgICAgICAgICAgICAgICAgICAgICAgIC0tcmVzb3VyY2UgTm9kZUdyb3VwICBcCiAgICAgICAgICAgICAgICAgICAgICAgIC0tcmVnaW9uICR7QVdTOjpSZWdpb259CgogICAgICBOb2RlR3JvdXA6CiAgICAgICAgVHlwZTogIkFXUzo6QXV0b1NjYWxpbmc6OkF1dG9TY2FsaW5nR3JvdXAiCiAgICAgICAgUHJvcGVydGllczoKICAgICAgICAgIERlc2lyZWRDYXBhY2l0eTogJzInCiAgICAgICAgICBMYXVuY2hUZW1wbGF0ZToKICAgICAgICAgICAgTGF1bmNoVGVtcGxhdGVJZDogIVJlZiBOb2RlTGF1bmNoVGVtcGxhdGUKICAgICAgICAgICAgVmVyc2lvbjogIUdldEF0dCBOb2RlTGF1bmNoVGVtcGxhdGUuTGF0ZXN0VmVyc2lvbk51bWJlcgogICAgICAgICAgTWF4U2l6ZTogJzUnCiAgICAgICAgICBNaW5TaXplOiAnMScKICAgICAgICAgIFRhZ3M6CiAgICAgICAgICAgIC0gS2V5OiBOYW1lCiAgICAgICAgICAgICAgUHJvcGFnYXRlQXRMYXVuY2g6IHRydWUKICAgICAgICAgICAgICBWYWx1ZTogRUtTLVdPUktTSE9QLU5HLU5vZGUKICAgICAgICAgICAgLSBLZXk6IGt1YmVybmV0ZXMuaW8vY2x1c3Rlci9FS1MtV09SS1NIT1AKICAgICAgICAgICAgICBQcm9wYWdhdGVBdExhdW5jaDogdHJ1ZQogICAgICAgICAgICAgIFZhbHVlOiBvd25lZAogICAgICAgICAgVlBDWm9uZUlkZW50aWZpZXI6ICFSZWYgU3VibmV0cwogICAgICAgIFVwZGF0ZVBvbGljeToKICAgICAgICAgIEF1dG9TY2FsaW5nUm9sbGluZ1VwZGF0ZToKICAgICAgICAgICAgTWF4QmF0Y2hTaXplOiAxCiAgICAgICAgICAgIE1pbkluc3RhbmNlc0luU2VydmljZTogMgogICAgICAgICAgICBQYXVzZVRpbWU6IFBUNU0KCiAgICBPdXRwdXRzOgogICAgICBOb2RlSW5zdGFuY2VSb2xlOgogICAgICAgIERlc2NyaXB0aW9uOiBUaGUgbm9kZSBpbnN0YW5jZSByb2xlCiAgICAgICAgVmFsdWU6ICFHZXRBdHQgTm9kZUluc3RhbmNlUm9sZS5Bcm4KCiAgICAgIE5vZGVTZWN1cml0eUdyb3VwOgogICAgICAgIERlc2NyaXB0aW9uOiBUaGUgc2VjdXJpdHkgZ3JvdXAgZm9yIHRoZSBub2RlIGdyb3VwCiAgICAgICAgVmFsdWU6ICFSZWYgTm9kZVNlY3VyaXR5R3JvdXAKCiAgICAgIE5vZGVBdXRvU2NhbGluZ0dyb3VwOgogICAgICAgIERlc2NyaXB0aW9uOiBUaGUgYXV0b3NjYWxpbmcgZ3JvdXAKICAgICAgICBWYWx1ZTogIVJlZiBOb2RlR3JvdXAKICBvd25lcjogcm9vdDpyb290CiAgcGF0aDogL3Zhci9saWIvY2xvdWQvc2NyaXB0cy9wZXItaW5zdGFuY2UvZWtzLW5vZGVncm91cC55YW1sCiAgcGVybWlzc2lvbnM6ICIwNzU1IgoKLS09PT09PT09PT09PT09PT1FS1NXT1JLU0hPUD09LS0K
      IamInstanceProfile: !Ref BastionInstanceProfile

  BastionInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      Path: "/"
      Roles:
        -
          Ref: "BastionInstanceRole"

  BastionInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
        - PolicyName: EKSAllPermissions
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: 'eks:*'
                Resource: '*'
              - Effect: Allow
                Action: 'cloudformation:*'
                Resource: '*'
              - Effect: Allow
                Action: 'ec2:*'
                Resource: '*'
              - Effect: Allow
                Action: 'iam:*'
                Resource: '*'
              - Effect: Allow
                Action: 'ssm:*'
                Resource: '*'
              - Effect: Allow
                Action: 'autoscaling:*'
                Resource: '*'
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly'
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEKSWorkerNodePolicy'
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEKS_CNI_Policy'
      Path: "/"

  EC2InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
        GroupDescription: Allow http to client host
        VpcId:
          Ref: BastionVPC
        SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

Outputs:

  EC2InstanceIP:
    Description: "The bastion instance public IP, $ ssh -A -i <YOUR_KEY_PAIR> ec2-user@<PUBLIC_IP>"
    Value: !GetAtt EC2Instance.PublicIp
